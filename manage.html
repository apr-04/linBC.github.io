<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>명함 관리</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <header>
        <h1>명함 관리</h1>
    </header>

    <div class="container">
        <!-- 로그인 화면 -->
        <div id="loginScreen" class="login-container">
            <div class="form-container">
                <h2 style="text-align: center; margin-bottom: 20px;">관리자 로그인</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginId">ID</label>
                        <input type="text" id="loginId" name="loginId" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" name="loginPassword" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">로그인</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 관리 화면 -->
        <div id="managementScreen" style="display: none;">
            <div id="alert-container"></div>

            <!-- 신청 목록 -->
            <div class="table-container" style="margin-bottom: 20px;">
                <h2>신청 목록</h2>
                <div style="margin-bottom: 10px;">
                    <button id="refreshBtn" class="btn btn-secondary">새로고침</button>
                </div>
                <div id="loadingIndicator" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>로딩 중...</p>
                </div>
                <table id="applicationTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>신청ID</th>
                            <th>신청자계정</th>
                            <th>통</th>
                            <th>Status</th>
                            <th>등록일</th>
                            <th>처리자</th>
                            <th>처리일자</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="applicationTableBody">
                    </tbody>
                </table>
            </div>

            <!-- 초안 업로드 및 이메일 발송 -->
            <div class="form-container">
                <h2>초안 업로드 및 확인 요청</h2>
                <form id="draftUploadForm">
                    <div class="form-group">
                        <label for="selectApplication">신청 선택 *</label>
                        <select id="selectApplication" name="selectApplication" required>
                            <option value="">-- 신청을 선택하세요 --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>초안 파일 업로드 *</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <p>파일을 드래그하거나 클릭하여 업로드</p>
                            <input type="file" id="draftFile" name="draftFile" accept="image/*" style="display: none;" required>
                        </div>
                        <div id="filePreview" style="margin-top: 10px;"></div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">초안 확인 요청 발송</button>
                    </div>
                </form>
            </div>

            <!-- 제작 완료 안내 -->
            <div class="form-container">
                <h2>제작 완료 안내</h2>
                <form id="completionForm">
                    <div class="form-group">
                        <label for="selectApplicationComplete">신청 선택 *</label>
                        <select id="selectApplicationComplete" name="selectApplicationComplete" required>
                            <option value="">-- 신청을 선택하세요 --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">수령 안내 이메일 발송</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/onedrive-api.js"></script>
    <script src="js/excel-handler.js"></script>
    <script>
        const ADMIN_ID = 'root';
        const ADMIN_PW = 'Templin12!@';

        let applications = [];
        let selectedApplication = null;

        // 로그인 처리
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;

            if (id === ADMIN_ID && password === ADMIN_PW) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showManagementScreen();
            } else {
                alert('ID 또는 Password가 올바르지 않습니다.');
            }
        });

        // 관리 화면 표시
        function showManagementScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('managementScreen').style.display = 'block';
            loadApplications();
        }

        // 세션 확인
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            showManagementScreen();
        }

        // 알림 메시지 표시
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // 신청 목록 로드
        async function loadApplications() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const table = document.getElementById('applicationTable');
            const tableBody = document.getElementById('applicationTableBody');
            const selectApplication = document.getElementById('selectApplication');
            const selectApplicationComplete = document.getElementById('selectApplicationComplete');

            try {
                loadingIndicator.style.display = 'block';
                table.style.display = 'none';

                // OneDrive 인증 확인
                await getAccessToken();

                // Excel 데이터 읽기
                const allData = await readExcelData();
                
                if (allData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">신청 내역이 없습니다.</td></tr>';
                    table.style.display = 'table';
                    loadingIndicator.style.display = 'none';
                    return;
                }

                const headers = allData[0];
                applications = [];

                // 헤더 인덱스 찾기
                const indices = {
                    신청ID: headers.indexOf('신청ID'),
                    신청자계정: headers.indexOf('신청자계정'),
                    통: headers.indexOf('통'),
                    Status: headers.indexOf('Status'),
                    등록일: headers.indexOf('등록일'),
                    처리자: headers.indexOf('처리자'),
                    처리일자: headers.indexOf('처리일자'),
                    첨부파일: headers.indexOf('첨부파일')
                };

                // 테이블 데이터 구성
                tableBody.innerHTML = '';
                selectApplication.innerHTML = '<option value="">-- 신청을 선택하세요 --</option>';
                selectApplicationComplete.innerHTML = '<option value="">-- 신청을 선택하세요 --</option>';

                for (let i = 1; i < allData.length; i++) {
                    const row = allData[i];
                    const app = {
                        신청ID: row[indices.신청ID] || '',
                        신청자계정: row[indices.신청자계정] || '',
                        통: row[indices.통] || '',
                        Status: row[indices.Status] || '신청',
                        등록일: row[indices.등록일] || '',
                        처리자: row[indices.처리자] || '',
                        처리일자: row[indices.처리일자] || '',
                        첨부파일: row[indices.첨부파일] || ''
                    };

                    // 삭제된 항목은 제외
                    if (app.Status === '삭제') continue;

                    applications.push(app);

                    // 테이블 행 추가
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${app.신청ID}</td>
                        <td>${app.신청자계정}</td>
                        <td>${app.통}</td>
                        <td><span class="status-badge status-${app.Status}">${app.Status}</span></td>
                        <td>${app.등록일}</td>
                        <td>${app.처리자 || '-'}</td>
                        <td>${app.처리일자 || '-'}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewApplication('${app.신청ID}')">상세보기</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);

                    // 선택 옵션 추가
                    const option = document.createElement('option');
                    option.value = app.신청ID;
                    option.textContent = `${app.신청ID} - ${app.신청자계정}`;
                    selectApplication.appendChild(option.cloneNode(true));
                    selectApplicationComplete.appendChild(option);
                }

                table.style.display = 'table';
                loadingIndicator.style.display = 'none';

            } catch (error) {
                console.error('Error loading applications:', error);
                showAlert('신청 목록을 불러오는 중 오류가 발생했습니다: ' + error.message, 'error');
                loadingIndicator.style.display = 'none';
            }
        }

        // 새로고침 버튼
        document.getElementById('refreshBtn').addEventListener('click', loadApplications);

        // 파일 업로드 영역
        const fileUploadArea = document.getElementById('fileUploadArea');
        const draftFileInput = document.getElementById('draftFile');
        const filePreview = document.getElementById('filePreview');

        fileUploadArea.addEventListener('click', () => draftFileInput.click());
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                draftFileInput.files = files;
                previewFile(files[0]);
            }
        });

        draftFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                previewFile(e.target.files[0]);
            }
        });

        function previewFile(file) {
            if (!file.type.startsWith('image/')) {
                showAlert('이미지 파일만 업로드 가능합니다.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                filePreview.innerHTML = `
                    <img src="${e.target.result}" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
                    <p style="margin-top: 10px;">${file.name}</p>
                `;
            };
            reader.readAsDataURL(file);
        }

        // 초안 업로드 및 확인 요청
        document.getElementById('draftUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const applicationId = document.getElementById('selectApplication').value;
            const file = draftFileInput.files[0];

            if (!applicationId || !file) {
                showAlert('신청과 초안 파일을 선택해주세요.', 'error');
                return;
            }

            try {
                // OneDrive에 초안 이미지 업로드
                const uploadResult = await uploadImageAndGetLink('/명함신청/초안', file);

                // Excel DB 업데이트 (첨부파일 필드)
                const app = applications.find(a => a.신청ID === applicationId);
                if (app) {
                    await updateRowInExcel(applicationId, {
                        첨부파일: uploadResult.downloadUrl
                    });
                }

                // 초안 확인 페이지 링크 생성
                const draftUrl = `${window.location.origin}/draft.html?id=${applicationId}&name=${encodeURIComponent(app.신청자계정.split('@')[0])}`;

                // 이메일 발송 (mailto)
                const emailSubject = encodeURIComponent(`[명함 초안 확인 요청] ${applicationId}`);
                const emailBody = encodeURIComponent(
                    `명함 초안이 준비되었습니다. 확인 후 승인 또는 수정 요청을 해주세요.\n\n` +
                    `신청ID: ${applicationId}\n` +
                    `초안 확인: ${draftUrl}\n\n` +
                    `초안 이미지: ${uploadResult.downloadUrl}`
                );
                const mailtoLink = `mailto:${app.신청자계정}?subject=${emailSubject}&body=${emailBody}`;
                window.open(mailtoLink);

                showAlert('초안 확인 요청 이메일이 발송되었습니다.', 'success');
                
                // 폼 초기화
                document.getElementById('draftUploadForm').reset();
                filePreview.innerHTML = '';
                loadApplications();

            } catch (error) {
                console.error('Error uploading draft:', error);
                showAlert('초안 업로드 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        });

        // 제작 완료 안내
        document.getElementById('completionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const applicationId = document.getElementById('selectApplicationComplete').value;

            if (!applicationId) {
                showAlert('신청을 선택해주세요.', 'error');
                return;
            }

            try {
                const app = applications.find(a => a.신청ID === applicationId);
                if (!app) {
                    showAlert('신청을 찾을 수 없습니다.', 'error');
                    return;
                }

                // Status를 "발급완료"로 업데이트
                await updateRowInExcel(applicationId, {
                    Status: '발급완료',
                    처리자: '관리자',
                    처리일자: new Date().toISOString().split('T')[0]
                });

                // 이메일 발송 (mailto)
                const emailSubject = encodeURIComponent(`[명함 제작 완료] ${applicationId}`);
                const emailBody = encodeURIComponent(
                    `명함 제작이 완료되었습니다. 수령해 주시기 바랍니다.\n\n` +
                    `신청ID: ${applicationId}\n` +
                    `명함통 개수: ${app.통}통\n` +
                    `처리일자: ${new Date().toISOString().split('T')[0]}`
                );
                const mailtoLink = `mailto:${app.신청자계정}?subject=${emailSubject}&body=${emailBody}`;
                window.open(mailtoLink);

                showAlert('수령 안내 이메일이 발송되었습니다.', 'success');
                loadApplications();

            } catch (error) {
                console.error('Error sending completion notice:', error);
                showAlert('이메일 발송 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        });

        // 상세보기 (간단한 팝업)
        function viewApplication(applicationId) {
            const app = applications.find(a => a.신청ID === applicationId);
            if (app) {
                alert(
                    `신청ID: ${app.신청ID}\n` +
                    `신청자계정: ${app.신청자계정}\n` +
                    `통: ${app.통}\n` +
                    `Status: ${app.Status}\n` +
                    `등록일: ${app.등록일}\n` +
                    `처리자: ${app.처리자 || '-'}\n` +
                    `처리일자: ${app.처리일자 || '-'}`
                );
            }
        }
    </script>
</body>
</html>

=======
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>명함 관리</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <header>
        <h1>명함 관리</h1>
    </header>

    <div class="container">
        <!-- 로그인 화면 -->
        <div id="loginScreen" class="login-container">
            <div class="form-container">
                <h2 style="text-align: center; margin-bottom: 20px;">관리자 로그인</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginId">ID</label>
                        <input type="text" id="loginId" name="loginId" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" name="loginPassword" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">로그인</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 관리 화면 -->
        <div id="managementScreen" style="display: none;">
            <div id="alert-container"></div>

            <!-- 신청 목록 -->
            <div class="table-container" style="margin-bottom: 20px;">
                <h2>신청 목록</h2>
                <div style="margin-bottom: 10px;">
                    <button id="refreshBtn" class="btn btn-secondary">새로고침</button>
                </div>
                <div id="loadingIndicator" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>로딩 중...</p>
                </div>
                <table id="applicationTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>신청ID</th>
                            <th>신청자계정</th>
                            <th>통</th>
                            <th>Status</th>
                            <th>등록일</th>
                            <th>처리자</th>
                            <th>처리일자</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="applicationTableBody">
                    </tbody>
                </table>
            </div>

            <!-- 초안 업로드 및 이메일 발송 -->
            <div class="form-container">
                <h2>초안 업로드 및 확인 요청</h2>
                <form id="draftUploadForm">
                    <div class="form-group">
                        <label for="selectApplication">신청 선택 *</label>
                        <select id="selectApplication" name="selectApplication" required>
                            <option value="">-- 신청을 선택하세요 --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>초안 파일 업로드 *</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <p>파일을 드래그하거나 클릭하여 업로드</p>
                            <input type="file" id="draftFile" name="draftFile" accept="image/*" style="display: none;" required>
                        </div>
                        <div id="filePreview" style="margin-top: 10px;"></div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">초안 확인 요청 발송</button>
                    </div>
                </form>
            </div>

            <!-- 제작 완료 안내 -->
            <div class="form-container">
                <h2>제작 완료 안내</h2>
                <form id="completionForm">
                    <div class="form-group">
                        <label for="selectApplicationComplete">신청 선택 *</label>
                        <select id="selectApplicationComplete" name="selectApplicationComplete" required>
                            <option value="">-- 신청을 선택하세요 --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">수령 안내 이메일 발송</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/onedrive-api.js"></script>
    <script src="js/excel-handler.js"></script>
    <script>
        const ADMIN_ID = 'root';
        const ADMIN_PW = 'Templin12!@';

        let applications = [];
        let selectedApplication = null;

        // 로그인 처리
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;

            if (id === ADMIN_ID && password === ADMIN_PW) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showManagementScreen();
            } else {
                alert('ID 또는 Password가 올바르지 않습니다.');
            }
        });

        // 관리 화면 표시
        function showManagementScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('managementScreen').style.display = 'block';
            loadApplications();
        }

        // 세션 확인
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            showManagementScreen();
        }

        // 알림 메시지 표시
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // 신청 목록 로드
        async function loadApplications() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const table = document.getElementById('applicationTable');
            const tableBody = document.getElementById('applicationTableBody');
            const selectApplication = document.getElementById('selectApplication');
            const selectApplicationComplete = document.getElementById('selectApplicationComplete');

            try {
                loadingIndicator.style.display = 'block';
                table.style.display = 'none';

                // OneDrive 인증 확인
                await getAccessToken();

                // Excel 데이터 읽기
                const allData = await readExcelData();
                
                if (allData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">신청 내역이 없습니다.</td></tr>';
                    table.style.display = 'table';
                    loadingIndicator.style.display = 'none';
                    return;
                }

                const headers = allData[0];
                applications = [];

                // 헤더 인덱스 찾기
                const indices = {
                    신청ID: headers.indexOf('신청ID'),
                    신청자계정: headers.indexOf('신청자계정'),
                    통: headers.indexOf('통'),
                    Status: headers.indexOf('Status'),
                    등록일: headers.indexOf('등록일'),
                    처리자: headers.indexOf('처리자'),
                    처리일자: headers.indexOf('처리일자'),
                    첨부파일: headers.indexOf('첨부파일')
                };

                // 테이블 데이터 구성
                tableBody.innerHTML = '';
                selectApplication.innerHTML = '<option value="">-- 신청을 선택하세요 --</option>';
                selectApplicationComplete.innerHTML = '<option value="">-- 신청을 선택하세요 --</option>';

                for (let i = 1; i < allData.length; i++) {
                    const row = allData[i];
                    const app = {
                        신청ID: row[indices.신청ID] || '',
                        신청자계정: row[indices.신청자계정] || '',
                        통: row[indices.통] || '',
                        Status: row[indices.Status] || '신청',
                        등록일: row[indices.등록일] || '',
                        처리자: row[indices.처리자] || '',
                        처리일자: row[indices.처리일자] || '',
                        첨부파일: row[indices.첨부파일] || ''
                    };

                    // 삭제된 항목은 제외
                    if (app.Status === '삭제') continue;

                    applications.push(app);

                    // 테이블 행 추가
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${app.신청ID}</td>
                        <td>${app.신청자계정}</td>
                        <td>${app.통}</td>
                        <td><span class="status-badge status-${app.Status}">${app.Status}</span></td>
                        <td>${app.등록일}</td>
                        <td>${app.처리자 || '-'}</td>
                        <td>${app.처리일자 || '-'}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewApplication('${app.신청ID}')">상세보기</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);

                    // 선택 옵션 추가
                    const option = document.createElement('option');
                    option.value = app.신청ID;
                    option.textContent = `${app.신청ID} - ${app.신청자계정}`;
                    selectApplication.appendChild(option.cloneNode(true));
                    selectApplicationComplete.appendChild(option);
                }

                table.style.display = 'table';
                loadingIndicator.style.display = 'none';

            } catch (error) {
                console.error('Error loading applications:', error);
                showAlert('신청 목록을 불러오는 중 오류가 발생했습니다: ' + error.message, 'error');
                loadingIndicator.style.display = 'none';
            }
        }

        // 새로고침 버튼
        document.getElementById('refreshBtn').addEventListener('click', loadApplications);

        // 파일 업로드 영역
        const fileUploadArea = document.getElementById('fileUploadArea');
        const draftFileInput = document.getElementById('draftFile');
        const filePreview = document.getElementById('filePreview');

        fileUploadArea.addEventListener('click', () => draftFileInput.click());
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                draftFileInput.files = files;
                previewFile(files[0]);
            }
        });

        draftFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                previewFile(e.target.files[0]);
            }
        });

        function previewFile(file) {
            if (!file.type.startsWith('image/')) {
                showAlert('이미지 파일만 업로드 가능합니다.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                filePreview.innerHTML = `
                    <img src="${e.target.result}" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
                    <p style="margin-top: 10px;">${file.name}</p>
                `;
            };
            reader.readAsDataURL(file);
        }

        // 초안 업로드 및 확인 요청
        document.getElementById('draftUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const applicationId = document.getElementById('selectApplication').value;
            const file = draftFileInput.files[0];

            if (!applicationId || !file) {
                showAlert('신청과 초안 파일을 선택해주세요.', 'error');
                return;
            }

            try {
                // OneDrive에 초안 이미지 업로드
                const uploadResult = await uploadImageAndGetLink('/명함신청/초안', file);

                // Excel DB 업데이트 (첨부파일 필드)
                const app = applications.find(a => a.신청ID === applicationId);
                if (app) {
                    await updateRowInExcel(applicationId, {
                        첨부파일: uploadResult.downloadUrl
                    });
                }

                // 초안 확인 페이지 링크 생성
                const draftUrl = `${window.location.origin}/draft.html?id=${applicationId}&name=${encodeURIComponent(app.신청자계정.split('@')[0])}`;

                // 이메일 발송 (mailto)
                const emailSubject = encodeURIComponent(`[명함 초안 확인 요청] ${applicationId}`);
                const emailBody = encodeURIComponent(
                    `명함 초안이 준비되었습니다. 확인 후 승인 또는 수정 요청을 해주세요.\n\n` +
                    `신청ID: ${applicationId}\n` +
                    `초안 확인: ${draftUrl}\n\n` +
                    `초안 이미지: ${uploadResult.downloadUrl}`
                );
                const mailtoLink = `mailto:${app.신청자계정}?subject=${emailSubject}&body=${emailBody}`;
                window.open(mailtoLink);

                showAlert('초안 확인 요청 이메일이 발송되었습니다.', 'success');
                
                // 폼 초기화
                document.getElementById('draftUploadForm').reset();
                filePreview.innerHTML = '';
                loadApplications();

            } catch (error) {
                console.error('Error uploading draft:', error);
                showAlert('초안 업로드 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        });

        // 제작 완료 안내
        document.getElementById('completionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const applicationId = document.getElementById('selectApplicationComplete').value;

            if (!applicationId) {
                showAlert('신청을 선택해주세요.', 'error');
                return;
            }

            try {
                const app = applications.find(a => a.신청ID === applicationId);
                if (!app) {
                    showAlert('신청을 찾을 수 없습니다.', 'error');
                    return;
                }

                // Status를 "발급완료"로 업데이트
                await updateRowInExcel(applicationId, {
                    Status: '발급완료',
                    처리자: '관리자',
                    처리일자: new Date().toISOString().split('T')[0]
                });

                // 이메일 발송 (mailto)
                const emailSubject = encodeURIComponent(`[명함 제작 완료] ${applicationId}`);
                const emailBody = encodeURIComponent(
                    `명함 제작이 완료되었습니다. 수령해 주시기 바랍니다.\n\n` +
                    `신청ID: ${applicationId}\n` +
                    `명함통 개수: ${app.통}통\n` +
                    `처리일자: ${new Date().toISOString().split('T')[0]}`
                );
                const mailtoLink = `mailto:${app.신청자계정}?subject=${emailSubject}&body=${emailBody}`;
                window.open(mailtoLink);

                showAlert('수령 안내 이메일이 발송되었습니다.', 'success');
                loadApplications();

            } catch (error) {
                console.error('Error sending completion notice:', error);
                showAlert('이메일 발송 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        });

        // 상세보기 (간단한 팝업)
        function viewApplication(applicationId) {
            const app = applications.find(a => a.신청ID === applicationId);
            if (app) {
                alert(
                    `신청ID: ${app.신청ID}\n` +
                    `신청자계정: ${app.신청자계정}\n` +
                    `통: ${app.통}\n` +
                    `Status: ${app.Status}\n` +
                    `등록일: ${app.등록일}\n` +
                    `처리자: ${app.처리자 || '-'}\n` +
                    `처리일자: ${app.처리일자 || '-'}`
                );
            }
        }
    </script>
</body>
</html>
